<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ“· Issue Book (Scan Student + Book)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    .scanner-container { max-width: 600px; margin: 30px auto; background: #f8f9fb; padding: 30px; border-radius: 14px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08); }
    .scanner-container h3 { text-align: center; margin-bottom: 20px; font-weight: 600; color: #2c3e50; }
    .form-style label { margin-top: 14px; font-weight: 600; display: block; color: #2c3e50; }
    .form-style input { width: 100%; padding: 10px; margin-top: 5px; font-size: 15px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
    .submit-btn { background-color: #2ecc71; color: white; padding: 12px 20px; margin-top: 25px; border-radius: 8px; border: none; font-size: 16px; width: 100%; cursor: pointer; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 9999px; margin-left: 6px; font-size: 12px; color: #fff; }
    .pill.student { background: #3498db; }
    .pill.book { background: #9b59b6; }
    .controls { display: flex; justify-content: center; gap: 10px; margin: 10px 0 20px; }
    .controls button { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; background: #34495e; color: #fff; }
    .hidden { display: none !important; }
    #reader-student, #reader-book {
      width: 100%;
      max-width: 400px;
      margin: auto;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid #ccc;
      background: #000;
    }
    #reader-student video, #reader-book video {
      width: 100% !important;
      height: auto !important;
      object-fit: cover;
      border-radius: 10px;
    }
    .form-wrapper {
    max-width: 600px;
    margin: 30px auto;
    padding: 30px;
    background: #ffffff;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.08);
    border-radius: 12px;
    font-family: "Segoe UI", sans-serif;
  }

  .form-wrapper label {
    font-weight: 600;
    margin-bottom: 6px;
    display: block;
    color: #333;
  }

  .form-wrapper input {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 20px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 15px;
    transition: border-color 0.2s;
  }

  .form-wrapper input:focus {
    border-color: #007bff;
    outline: none;
  }

  .submit-btn {
    width: 100%;
    background-color: #007bff;
    border: none;
    color: white;
    padding: 12px;
    font-size: 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
  }

  .submit-btn:hover {
    background-color: #0056b3;
  }

  @media (max-width: 600px) {
    .form-wrapper {
      padding: 20px;
    }
  }
  </style>
</head>
<body>
  {% include "library/navbar.html" %}

  <div class="container my-4">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">ðŸ“· Scan Student & Book</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <!-- Student Barcode Scanner -->
            <div class="col-md-6 text-center mb-4">
              <h6 class="mb-2">ðŸŽ“ Student Barcode Scanner</h6>
              <div id="reader-student" class="border rounded bg-light" style="width: 100%; height: 250px;"></div>
              <span id="student-pill" class="badge badge-success mt-2" style="display:none;">Student Scanned</span>
            </div>

            <!-- Book QR Scanner -->
            <div class="col-md-6 text-center mb-4">
              <h6 class="mb-2">ðŸ“š Book QR Scanner</h6>
              <div id="reader-book" class="border rounded bg-light" style="width: 100%; height: 250px;"></div>
              <span id="book-pill" class="badge badge-info mt-2" style="display:none;">Book Scanned</span>
            </div>
          </div>

          <!-- Scan Status -->
          <div class="text-center mt-3">
            <p id="phase-text" class="text-muted">Please scan student barcode first, then scan book QR.</p>
            <p class="text-secondary small">Ensure camera permissions are enabled.</p>
          </div>

          <!-- Reset Button -->
          <div class="text-center mt-2">
            <button id="btn-reset" class="btn btn-outline-danger">ðŸ”„ Reset Scan</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<form id="issueForm" class="form-wrapper" method="post" action="{% url 'issue_book' %}">

  {% csrf_token %}
  <label>Student Name</label>
  <input type="text" id="username" name="username" required>

  <label>Roll Number</label>
  <input type="text" id="roll_number" name="roll_number" required>

  <label>Mobile Number</label>
  <input type="text" id="mobile_number" name="mobile_number" required>

  <label>Email</label>
  <input type="email" id="email" name="email" required>

  <input type="hidden" id="book_id" name="book_id" value="{{ initial.book_id }}">

  <label>Book Unique ID</label>
  <input type="text" id="book_unique_id" name="book_unique_id" required readonly>

  <label>Book Title</label>
  <input type="text" id="book_title" name="book_title" required>

  <label>ISBN</label>
  <input type="text" id="isbn" name="isbn" required>

  <label>Genre</label>
  <input type="text" id="genre" name="genre">

  <label>Language</label>
  <input type="text" id="language" name="language">

  <label for="issued_date">Issued Date (optional)</label>
  <input type="date" name="issued_date" id="issued_date">

  <button type="submit" class="submit-btn">ðŸ“¥ Issue Book</button>
</form>


  <script>
    let qrScannerBook = null;
    let studentScanned = false;
    let bookScanned = false;

    const beep = document.getElementById('beep');
    const studentPill = document.getElementById('student-pill');
    const bookPill = document.getElementById('book-pill');
    const phaseText = document.getElementById('phase-text');
    const btnReset = document.getElementById('btn-reset');

    function playBeep() {
      if (beep) {
        beep.currentTime = 0;
        beep.play().catch(() => {});
      }
    }

    function startStudentBarcodeScanner() {
      phaseText.innerHTML = 'Phase 1: Scan the <b>Student Barcode</b>';
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#reader-student'),
          constraints: { facingMode: "environment" }
        },
        decoder: { readers: ["code_128_reader"] },
      }, function(err) {
        if (err) return console.error(err);
        Quagga.start();
      });

      Quagga.onDetected(function(result) {
        if (studentScanned) return;
        studentScanned = true;

        const barcodeData = result.codeResult.code;
        playBeep();

        fetch(`/api/scan-lookup/?code=${barcodeData}`)
          .then(res => res.json())
          .then(data => {
            if (data.error) return alert("Student not found!");

            document.getElementById('username').value = data.username || '';
            document.getElementById('roll_number').value = data.roll_number || '';
            document.getElementById('mobile_number').value = data.mobile_number || '';
            document.getElementById('email').value = data.email || '';

            studentPill.style.display = "inline-block";
            phaseText.innerHTML = 'Phase 2: Scan the <b>Book QR Code</b>';

            Quagga.stop();
            startBookQRScanner();
          }).catch(err => {
            console.error(err);
            alert("Error fetching student data.");
          });
      });
    }

    function startBookQRScanner() {
      bookScanned = false;
      document.getElementById("reader-book").classList.remove("hidden");

      qrScannerBook = new Html5Qrcode("reader-book");
      qrScannerBook.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: { width: 250, height: 250 }
        },
        function(decodedText, decodedResult) {
          if (bookScanned) return;

          const parts = decodedText.split('|');
          if (parts.length >= 7 && parts[0] === "BOOK") {
            document.getElementById("book_id").value = parts[1]; 
            document.getElementById("book_unique_id").value = parts[2];
            document.getElementById("book_title").value = parts[3];
            document.getElementById("genre").value = parts[4];
            document.getElementById("language").value = parts[5];
            document.getElementById("isbn").value = parts[6];

            bookScanned = true;
            playBeep();

            bookPill.style.display = "inline-block";
            phaseText.innerHTML = "âœ… All set! Submit form below.";

            qrScannerBook.stop().then(() => {
              document.getElementById("reader-book").innerHTML = "";
            });
          } else {
            alert("Invalid QR. Format: BOOK|ID|unique_id|Title|Genre|Lang|ISBN");
          }
        }
      ).catch(err => {
        console.error("Book QR scanner failed:", err);
      });
    }

    btnReset.addEventListener('click', () => {
      try { Quagga.stop(); } catch(e) {}
      try { qrScannerBook.stop(); } catch(e) {}

      studentScanned = false;
      bookScanned = false;

      document.getElementById("reader-student").innerHTML = "";
      document.getElementById("reader-book").innerHTML = "";
      document.getElementById("reader-book").classList.add("hidden");

      studentPill.style.display = "none";
      bookPill.style.display = "none";
      phaseText.innerHTML = 'Phase 1: Scan the <b>Student Barcode</b>';

      startStudentBarcodeScanner();
    });

    window.onload = () => startStudentBarcodeScanner();



    

  </script>
</body>
</html>
